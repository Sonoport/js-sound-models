/*javascript-sound-models - v0.3.0 - 2014-04-09 */

define("core/Config",[],function(){function e(){}return e.MAX_VOICES=8,e.NOMINAL_REFRESH_RATE=60,e}),define("core/AudioContextMonkeyPatch",[],function(){function e(e){e&&(e.setTargetAtTime||(e.setTargetAtTime=e.setTargetValueAtTime))}window.hasOwnProperty("webkitAudioContext")&&!window.hasOwnProperty("AudioContext")&&(window.AudioContext=webkitAudioContext,AudioContext.prototype.hasOwnProperty("createGain")||(AudioContext.prototype.createGain=AudioContext.prototype.createGainNode),AudioContext.prototype.hasOwnProperty("createDelay")||(AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode),AudioContext.prototype.hasOwnProperty("createScriptProcessor")||(AudioContext.prototype.createScriptProcessor=AudioContext.prototype.createJavaScriptNode),AudioContext.prototype.internal_createGain=AudioContext.prototype.createGain,AudioContext.prototype.createGain=function(){var t=this.internal_createGain();return e(t.gain),t},AudioContext.prototype.internal_createDelay=AudioContext.prototype.createDelay,AudioContext.prototype.createDelay=function(t){var n=t?this.internal_createDelay(t):this.internal_createDelay();return e(n.delayTime),n},AudioContext.prototype.internal_createBufferSource=AudioContext.prototype.createBufferSource,AudioContext.prototype.createBufferSource=function(){var t=this.internal_createBufferSource();return t.start||(t.start=function(e,t,n){t||n?this.noteGrainOn(e,t,n):this.noteOn(e)}),t.stop||(t.stop=t.noteOff),e(t.playbackRate),t},AudioContext.prototype.internal_createDynamicsCompressor=AudioContext.prototype.createDynamicsCompressor,AudioContext.prototype.createDynamicsCompressor=function(){var t=this.internal_createDynamicsCompressor();return e(t.threshold),e(t.knee),e(t.ratio),e(t.reduction),e(t.attack),e(t.release),t},AudioContext.prototype.internal_createBiquadFilter=AudioContext.prototype.createBiquadFilter,AudioContext.prototype.createBiquadFilter=function(){var t=this.internal_createBiquadFilter();return e(t.frequency),e(t.detune),e(t.Q),e(t.gain),t},AudioContext.prototype.hasOwnProperty("createOscillator")&&(AudioContext.prototype.internal_createOscillator=AudioContext.prototype.createOscillator,AudioContext.prototype.createOscillator=function(){var t=this.internal_createOscillator();return t.start||(t.start=t.noteOn),t.stop||(t.stop=t.noteOff),e(t.frequency),e(t.detune),t}))}),define("core/BaseSound",["core/AudioContextMonkeyPatch"],function(){function e(e){"undefined"==typeof e?(console.log("Making a new AudioContext"),this.audioContext=new AudioContext):this.audioContext=e,this.maxSources=0,this.releaseGainNode=this.audioContext.createGain(),this.FADE_TIME=.5,this.FADE_TIME_PAD=1,this.isPlaying=!1,this.inputNode=null}return e.prototype.connect=function(t){if(t instanceof e){if(!t.inputNode)throw{name:"No Input Connection Exception",message:"Attempts to connect "+typeof t+" to "+typeof this,toString:function(){return this.name+": "+this.message}};this.releaseGainNode.connect(t.inputNode)}else{if(!(t instanceof AudioNode))throw{name:"Incorrect Output Exception",message:"Attempts to connect "+typeof t+" to "+typeof this,toString:function(){return this.name+": "+this.message}};this.releaseGainNode.connect(t)}},e.prototype.disconnect=function(e){this.releaseGainNode.disconnect(e)},e.prototype.start=function(){this.isPlaying=!0},e.prototype.stop=function(e){this.isPlaying=!1,"undefined"==typeof e&&(e=0),this.releaseGainNode.gain.cancelScheduledValues(this.audioContext.currentTime+e)},e.prototype.release=function(e){e=e||this.FADE_TIME,this.releaseGainNode.gain.setValueAtTime(this.releaseGainNode.gain.value,this.audioContext.currentTime),this.releaseGainNode.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+e)},e.prototype.play=function(){this.start(0)},e.prototype.pause=function(){},e}),define("core/SPAudioParam",[],function(){function e(e,t,n,o,a,r,i,u){var c,s=1e-4,l=500;this.defaultValue=null,this.maxValue=0,this.minValue=0,this.name="";var f=0;if(Object.defineProperty(this,"value",{enumerable:!0,set:function(e){if(typeof e!=typeof o)throw{name:"Incorrect value type Exception",message:"Attempt to set a "+typeof o+" parameter to a "+typeof e+" value",toString:function(){return this.name+": "+this.message}};"number"==typeof e&&(e>n?(console.log("Clamping to max"),e=n):t>e&&(console.log("Clamping to min"),e=t)),"function"==typeof r&&(e=r(e)),"function"==typeof i&&u?i(a,e,u):a?a instanceof AudioParam?a.value=e:a instanceof Array&&a.forEach(function(t){t.value=e}):window.clearInterval(c),f=e},get:function(){if(a){if(a instanceof AudioParam)return a.value;if(a instanceof Array)return a[0].value}return f}}),a&&(a instanceof AudioParam||a instanceof Array)){var p=a[0]||a;this.defaultValue=p.defaultValue,this.minValue=p.minValue,this.maxValue=p.maxValue,this.value=p.defaultValue,this.name=p.name}(o||0===o)&&(this.defaultValue=o,this.value=o),e&&(this.name=e),(t||0===t)&&(this.minValue=t),(n||0===n)&&(this.maxValue=n),this.setValueAtTime=function(e,t){if(console.log("setting value "+e+" at time "+t+" for "+a),"function"==typeof r&&(e=r(e)),a)a instanceof AudioParam?a.setValueAtTime(e,t):a instanceof Array&&a.forEach(function(n){n.setValueAtTime(e,t)});else{var n=this,o=t-u.currentTime;window.setTimeout(function(){n.value=e},1e3*o)}},this.setTargetAtTime=function(e,t,n){if("function"==typeof r&&(e=r(e)),a)a instanceof AudioParam?a.setTargetAtTime(e,t,n):a instanceof Array&&a.forEach(function(o){o.setTargetAtTime(e,t,n)});else{var o=this,i=o.value,f=u.currentTime;c=window.setInterval(function(){u.currentTime>=t&&(o.value=e+(i-e)*Math.exp(-(u.currentTime-f)/n),Math.abs(o.value-e)<s&&window.clearInterval(c))},l)}},this.setValueCurveAtTime=function(e,t,n){if("function"==typeof r)for(var o=0;o<e.length;o++)e[o]=r(e[o]);if(a)a instanceof AudioParam?a.setValueCurveAtTime(e,t,n):a instanceof Array&&a.forEach(function(o){o.setValueCurveAtTime(e,t,n)});else{var i=this,s=u.currentTime;c=window.setInterval(function(){if(u.currentTime>=t){var o=Math.floor(e.length*(u.currentTime-s)/n);o<e.length?i.value=e[o]:window.clearInterval(c)}},l)}},this.exponentialRampToValueAtTime=function(e,t){if("function"==typeof r&&(e=r(e)),a)a instanceof AudioParam?a.exponentialRampToValueAtTime(e,t):a instanceof Array&&a.forEach(function(n){n.exponentialRampToValueAtTime(e,t)});else{var n=this,o=n.value,i=u.currentTime;0===o&&(o=.001),c=window.setInterval(function(){var a=(u.currentTime-i)/(t-i);n.value=o*Math.pow(e/o,a),u.currentTime>=t&&window.clearInterval(c)},l)}},this.linearRampToValueAtTime=function(e,t){if("function"==typeof r&&(e=r(e)),a)a instanceof AudioParam?a.linearRampToValueAtTime(e,t):a instanceof Array&&a.forEach(function(n){n.linearRampToValueAtTime(e,t)});else{var n=this,o=n.value,i=u.currentTime;c=window.setInterval(function(){var a=(u.currentTime-i)/(t-i);n.value=o+(e-o)*a,u.currentTime>=t&&window.clearInterval(c)},l)}},this.cancelScheduledValues=function(e){a?a instanceof AudioParam?a.cancelScheduledValues(e):a instanceof Array&&a.forEach(function(t){t.cancelScheduledValues(e)}):window.clearInterval(c)}}return e.createPsuedoParam=function(t,n,o,a,r){return new e(t,n,o,a,null,null,null,r)},e}),define("core/SPPlaybackRateParam",[],function(){function e(e,t){this.defaultValue=e.defaultValue,this.maxValue=e.maxValue,this.minValue=e.minValue,this.name=e.name,this.units=e.units,Object.defineProperty(this,"value",{enumerable:!0,set:function(n){e.value=n,t.value=n},get:function(){return e.value}}),this.linearRampToValueAtTime=function(n,o){e.linearRampToValueAtTime(n,o),t.linearRampToValueAtTime(n,o)},this.exponentialRampToValueAtTime=function(n,o){e.exponentialRampToValueAtTime(n,o),t.exponentialRampToValueAtTime(n,o)},this.setValueCurveAtTime=function(n,o,a){e.setValueCurveAtTime(n,o,a),t.setValueCurveAtTime(n,o,a)},this.setTargetAtTime=function(n,o,a){e.setTargetAtTime(n,o,a),t.setTargetAtTime(n,o,a)},this.setValueAtTime=function(n,o){e.setValueAtTime(n,o),t.setValueAtTime(n,o)},this.cancelScheduledValues=function(n){e.cancelScheduledValues(n),t.cancelScheduledValues(n)}}return e}),define("core/SPAudioBufferSourceNode",["core/SPPlaybackRateParam"],function(e){function t(t){function n(e){for(var n=new Float32Array(e.length),o=t.createBuffer(1,e.length,44100),a=0;a<e.length;a++)n[a]=a;return o.getChannelData(0).set(n),o}function o(){i.connect(u),u.onaudioprocess=a}function a(e){var t=e.inputBuffer.getChannelData(0);c=t[t.length]}var r=t.createBufferSource(),i=t.createBufferSource(),u=t.createScriptProcessor(),c=0;this.channelCount=r.channelCount,this.channelCountMode=r.channelCountMode,this.channelInterpretation=r.channelInterpretation,this.numberOfInputs=r.numberOfInputs,this.numberOfOutputs=r.numberOfOutputs,this.playbackState=r.playbackState,this.playbackRate=new e(r.playbackRate,i.playbackRate),Object.defineProperty(this,"loopEnd",{enumerable:!0,set:function(e){r.loopEnd=e,i.loopEnd=e},get:function(){return r.loopEnd}}),Object.defineProperty(this,"loopStart",{enumerable:!0,set:function(e){r.loopStart=e,i.loopStart=e},get:function(){return r.loopStart}}),Object.defineProperty(this,"onended",{enumerable:!0,set:function(e){r.onended=e},get:function(){return r.onended}}),Object.defineProperty(this,"gain",{enumerable:!0,set:function(e){r.gain=e},get:function(){return r.gain}}),Object.defineProperty(this,"loop",{enumerable:!0,set:function(e){r.loop=e,i.loop=e},get:function(){return r.loop}}),Object.defineProperty(this,"playbackPosition",{enumerable:!0,get:function(){return c}}),Object.defineProperty(this,"buffer",{enumerable:!0,set:function(e){r.buffer=e,i.buffer=n(e)},get:function(){return r.buffer}}),this.connect=function(e){r.connect(e),u.connect(e)},this.disconnect=function(e){r.disconnect(e),u.disconnect(e)},this.start=function(e,t){r.start(e,t),i.start(e,t)},this.stop=function(e){r.stop(e),i.stop(e)},o()}return t}),define("core/DetectLoopMarkers",[],function(){function e(e){self=this;var t=0,n=0;this.PREPOSTFIX_LEN=5e3,this.SPIKE_THRESH=.5,this.MAX_MP3_SILENCE=2e4,this.SILENCE_THRESH=.1;var o=function(e){var o,a,r=-1,i=-1;n=e.length-1,a=new Float32Array(e.getChannelData(0)),2===e.numberOfChannels&&(o=new Float32Array(e.getChannelData(1)));for(var u=0;0>r&&u<e.length&&u<self.MAX_MP3_SILENCE;){if(a[u]>self.SPIKE_THRESH&&(1===e.numberOfChannels||o[u]<-self.SPIKE_THRESH)){r=u;break}u++}for(u=e.length-1;0>i&&u>0&&e.length-u<self.MAX_MP3_SILENCE;){if(a[u]>self.SPIKE_THRESH&&(1===e.numberOfChannels||o[u]<-self.SPIKE_THRESH)){i=u;break}u--}return r>0&&i>0&&i>r?(t=r+self.PREPOSTFIX_LEN/2,n=i-self.PREPOSTFIX_LEN/2,!0):(t=0,n=e.length,!1)},a=function(e,n){return e&&n[t]<self.SILENCE_THRESH},r=function(e){for(var o=[],r=!0,i=0;i<e.numberOfChannels;i++)o.push(new Float32Array(e.getChannelData(i)));for(t=0;t<self.MAX_MP3_SILENCE&&t<e.length&&(r=o.reduce(a,!0));)t++;for(n=e.length-1;e.length-n<self.MAX_MP3_SILENCE&&n>0&&(r=o.reduce(a,!0));)n--;t>n&&(t=0,nLoopLength_=e.length)};return 2===e.numberOfChannels&&o(e)||r(e),{start:t,end:n}}return e}),define("core/FileLoader",["core/DetectLoopMarkers"],function(e){function t(n,o,a){function r(){var e=Object.prototype.toString.call(n),t=/[^.]+$/.exec(n);if("[object String]"===e){var o=new XMLHttpRequest;o.open("GET",n,!0),o.responseType="arraybuffer",o.onload=function(){i(o.response,t)},o.send()}else if("[object File]"===e){var a=new FileReader;a.onload=function(){i(a.result,t)},a.readAsArrayBuffer(n)}}function i(t,n){o.decodeAudioData(t,function(t){if(l=!0,u=t,c=0,s=u.length,"wav"!==n[0]){var o=e(u);o&&(c=o.start,s=o.end)}a&&"function"==typeof a&&a(!0)},function(){console.log("Error Decoding "+URL),a&&"function"==typeof a&&a(!1)})}if(!(this instanceof t))throw new TypeError("FileLoader constructor cannot be called as a function.");var u,c=0,s=0,l=!1,f=function(e){var t=/^[0-9]+$/;return t.test(e)?!0:!1},p=function(e,t){if("undefined"==typeof t&&(t=u.length),!f(e))throw{name:"Incorrect parameter type Exception",message:"FileLoader getBuffer start parameter is not an integer",toString:function(){return this.name+": "+this.message}};if(!f(t))throw{name:"Incorrect parameter type Exception",message:"FileLoader getBuffer end parameter is not an integer",toString:function(){return this.name+": "+this.message}};if(e>t)throw{name:"Incorrect parameter type Exception",message:"FileLoader getBuffer start parameter should be smaller than end parameter",toString:function(){return this.name+": "+this.message}};if(e>s||c>e)throw{name:"Incorrect parameter type Exception",message:"FileLoader getBuffer start parameter should be within the buffer size : 0-"+u.length,toString:function(){return this.name+": "+this.message}};if(t>s||c>t)throw{name:"Incorrect parameter type Exception",message:"FileLoader getBuffer end parameter should be within the buffer size : 0-"+u.length,toString:function(){return this.name+": "+this.message}};for(var n=t-e,a=o.createBuffer(u.numberOfChannels,n,u.sampleRate),r=0;r<u.numberOfChannels;r++){var i=new Float32Array(u.getChannelData(r));a.getChannelData(r).set(i.subarray(e,t))}return a};this.getBuffer=function(e,t){return"undefined"==typeof e&&(e=0),"undefined"==typeof t&&(t=s-c),p(c+e,c+t)},this.getRawBuffer=function(){return u},this.isLoaded=function(){return l},r()}return t}),define("core/MultiFileLoader",["core/FileLoader"],function(e){function t(t,n,o){function a(){var e=Object.prototype.toString.call(t);"[object Array]"===e?(c=t.length,t.forEach(function(e){r(e,i)})):void 0!==t&&null!==t&&(c=1,r(t,i))}function r(t,n){var o=Object.prototype.toString.call(t);if("[object String]"===o||"[object File]"===o)var a=new e(t,u.audioContext,function(e){e&&n(e,a.getBuffer())});else{if("[object AudioBuffer]"!==o)throw{name:"Incorrect Parameter type Exception",message:"Looper argument is not a URL or AudioBuffer",toString:function(){return this.name+": "+this.message}};n(!0,t)}}function i(e,t){c--,s.push(t),0===c&&o(e,s)}var u=this,c=0,s=[];a()}return t}),define("models/Looper",["core/Config","core/BaseSound","core/SPAudioParam","core/SPAudioBufferSourceNode","core/MultiFileLoader"],function(e,t,n,o,a){function r(i,u,c,s){function l(e){var t=Object.prototype.toString.call(e);if("[object Array]"===t&&e.length>f.maxSources)throw{name:"Unsupported number of sources",message:"This sound only supports a maximum of "+f.maxSources+" sources.",toString:function(){return this.name+": "+this.message}};m=[],p=[],h=[],f.multiTrackGain=[],a.call(f,e,s,y)}if(!(this instanceof r))throw new TypeError("Looper constructor cannot be called as a function.");t.call(this,s),this.maxSources=e.MAX_VOICES;var f=this,p=[],h=[],d=[],m=[],y=function(e,t){t.forEach(function(e,t){d.push(0),A(e,t)}),f.playSpeed=new n("playSpeed",-10,10,1,m,null,T,this.audioContext),f.releaseGainNode.connect(s.destination),"function"==typeof u&&u(e)},g=function(e,t){f.isPlaying=!1,c(f,t)},A=function(e,t){var a=new o(f.audioContext),r=f.audioContext.createGain();a.buffer=e,a.loopEnd=e.duration,a.onended=function(e){g(e,t)},a.connect(r),r.connect(f.releaseGainNode);var i=new n("gainNode",0,1,1,r.gain,null,null,f.audioContext);p.push(a),h.push(r),f.multiTrackGain.push(i),m.push(a.playbackRate)},T=function(e,t,n){var o=6.90776,a=p[0]?p[0].playbackRate.value:1;t>a?p.forEach(function(e){e.playbackRate.cancelScheduledValues(n.currentTime),e.playbackRate.setTargetAtTime(t,n.currentTime,f.riseTime.value*o)}):a>t&&p.forEach(function(e){e.playbackRate.cancelScheduledValues(n.currentTime),e.playbackRate.setTargetAtTime(t,n.currentTime,f.decayTime.value*o)})},v=function(e,t){p.forEach(function(e){e.loopStart=t*e.buffer.duration})};this.riseTime=n.createPsuedoParam("riseTime",.05,10,1,this.audioContext),this.decayTime=n.createPsuedoParam("decayTime",.05,10,1,this.audioContext),this.startPoint=new n("startPoint",0,.99,0,null,null,v,this.audioContext),this.playSpeed=null,this.multiTrackGain=[],this.maxLoops=n.createPsuedoParam("maxLoops",-1,1,-1,this.audioContext),this.setSources=function(e){l(e)},this.play=function(){this.isPlaying||p.forEach(function(e,t){var n=d&&d[t]?d[t]:f.startPoint.value*e.buffer.duration;e.loop=1!==f.maxLoops.value,e.start(0,n)}),t.prototype.start.call(this,0)},this.start=function(e,n){this.isPlaying||p.forEach(function(t){"undefined"==typeof n&&(n=f.startPoint.value*t.buffer.duration),console.log("Playing"),t.loop=1!==f.maxLoops.value,t.start(e,n)}),t.prototype.start.call(this,e)},this.stop=function(e){this.isPlaying&&(p=p.map(function(t,n){t.stop(e),d[n]=0;var a=new o(f.audioContext);return a.buffer=t.buffer,a.loopStart=a.buffer.duration*f.startPoint.value,a.loopEnd=a.buffer.duration,a.connect(h[n]),a.onended=function(e){g(e,n)},a})),t.prototype.stop.call(this,e)},this.pause=function(){this.isPlaying&&(p=p.map(function(e,t){e.stop(0),d[t]=e.playbackPosition/e.buffer.sampleRate,e.disconnect();var n=new o(f.audioContext);return n.buffer=e.buffer,n.loopStart=n.buffer.duration*f.startPoint.value,n.loopEnd=n.buffer.duration,n.connect(h[t]),n.onended=function(e){g(e,t)},n})),t.prototype.stop.call(this,0)},l(i)}return r.prototype=Object.create(t.prototype),r});